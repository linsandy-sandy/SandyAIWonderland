<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>魔法故事機 | Sandy's AI Wonderland</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 引入可愛的圓體字 -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #f5f3ff; /* Violet-50 */
            background-image: radial-gradient(#ddd6fe 2px, transparent 2px);
            background-size: 30px 30px;
            color: #4c1d95; /* Violet-900 */
        }

        /* 玻璃擬態卡片 */
        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(139, 92, 246, 0.1);
        }

        /* 魔法書頁效果 */
        .magic-paper {
            background-color: #ffffff;
            background-image: linear-gradient(#f0fdf4 1px, transparent 1px); /* 淡淡的格線 */
            background-size: 100% 2rem;
            box-shadow: 
                0 0 0 1px #e2e8f0,
                0 10px 15px -3px rgba(0, 0, 0, 0.1), 
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                inset 20px 0 50px rgba(0,0,0,0.02); /* 書脊陰影 */
            line-height: 2rem; /* 對齊格線 */
        }

        /* 載入動畫 */
        .bounce-dot {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .bounce-dot:nth-child(1) { animation-delay: -0.32s; }
        .bounce-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* 小圖漂浮動畫 (New) */
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(2deg); }
        }
        .float-anim {
            animation: float 4s ease-in-out infinite;
        }
    </style>
</head>
<body class="min-h-screen p-6 md:p-12 flex flex-col items-center">

    <!-- 導航列 -->
    <nav class="w-full max-w-6xl flex justify-between items-center mb-10">
        <a href="index.html" class="flex items-center gap-2 text-violet-500 hover:text-violet-700 transition-colors bg-white/50 px-4 py-2 rounded-full">
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
            <span class="font-bold">回到魔法屋</span>
        </a>
        <div class="flex items-center gap-2 text-violet-400">
            <i data-lucide="sparkles" class="w-5 h-5"></i>
            <span class="text-sm font-bold">Story Engine v1.0</span>
        </div>
    </nav>

    <!-- 主內容區：雙欄佈局 -->
    <main class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- 左側：控制台 (Inputs) -->
        <!-- 加入 relative 以便定位小圖 -->
        <div class="glass-panel rounded-3xl p-8 h-fit lg:sticky lg:top-8 relative">
            
            <!-- 可愛小圖裝飾 (New) -->
            <!-- 使用 sandy2_500.png，定位在右上角，稍微探頭出來 -->
            <img src="sandy2_500.png" 
                 class="absolute -top-20 -right-4 w-32 md:w-40 drop-shadow-lg float-anim z-10 pointer-events-none" 
                 alt="Story Mascot">

            <div class="flex items-center gap-3 mb-6 relative z-0">
                <div class="w-10 h-10 bg-violet-100 rounded-xl flex items-center justify-center text-violet-500">
                    <i data-lucide="feather" class="w-6 h-6"></i>
                </div>
                <h2 class="text-2xl font-bold text-violet-900">故事設定</h2>
            </div>

            <div class="space-y-6 relative z-0">
                <!-- 1. 關鍵字 -->
                <div>
                    <label class="block text-sm font-bold text-violet-600 mb-2">故事主角與元素</label>
                    <input type="text" id="keywords" placeholder="例如：一隻戴墨鏡的貓、外太空、珍珠奶茶" 
                           class="w-full px-4 py-3 rounded-xl border border-violet-100 focus:border-violet-400 focus:ring-2 focus:ring-violet-200 outline-none transition-all text-slate-600 bg-white/80">
                </div>

                <!-- 2. 風格選擇 -->
                <div>
                    <label class="block text-sm font-bold text-violet-600 mb-2">故事風格</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="setStyle(this, '溫馨童話')" class="style-btn px-4 py-2 rounded-lg border border-violet-200 text-violet-500 hover:bg-violet-50 text-sm font-bold transition-colors text-center active-style">溫馨童話</button>
                        <button onclick="setStyle(this, '奇幻冒險')" class="style-btn px-4 py-2 rounded-lg border border-violet-200 text-violet-500 hover:bg-violet-50 text-sm font-bold transition-colors text-center">奇幻冒險</button>
                        <button onclick="setStyle(this, '搞笑幽默')" class="style-btn px-4 py-2 rounded-lg border border-violet-200 text-violet-500 hover:bg-violet-50 text-sm font-bold transition-colors text-center">搞笑幽默</button>
                        <button onclick="setStyle(this, '科幻未來')" class="style-btn px-4 py-2 rounded-lg border border-violet-200 text-violet-500 hover:bg-violet-50 text-sm font-bold transition-colors text-center">科幻未來</button>
                    </div>
                </div>

                <!-- 3. 長度設定 -->
                <div>
                    <label class="block text-sm font-bold text-violet-600 mb-2">篇幅長度</label>
                    <input type="range" id="lengthSlider" min="1" max="3" value="2" class="w-full accent-violet-500 cursor-pointer">
                    <div class="flex justify-between text-xs text-violet-400 font-bold mt-1">
                        <span>短篇 (睡前)</span>
                        <span>中篇</span>
                        <span>長篇</span>
                    </div>
                </div>

                <!-- 生成按鈕 -->
                <button onclick="generateStory()" id="generateBtn" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-violet-500/30 hover:scale-[1.02] active:scale-95 transition-all flex justify-center items-center gap-2 mt-4">
                    <i data-lucide="wand-2" class="w-5 h-5"></i>
                    <span>開始施展魔法</span>
                </button>
            </div>
        </div>

        <!-- 右側：魔法書頁 (Output) -->
        <div class="lg:col-span-2 relative">
            <!-- 裝飾用書籤 -->
            <div class="absolute top-0 right-8 w-8 h-24 bg-red-400 rounded-b-lg shadow-md z-10"></div>
            
            <div class="magic-paper rounded-r-2xl rounded-l-md p-8 md:p-12 min-h-[600px] relative">
                
                <!-- 預設空狀態 -->
                <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-violet-300 opacity-60">
                    <i data-lucide="book-dashed" class="w-24 h-24 mb-4"></i>
                    <p class="text-lg">等待輸入魔法咒語...</p>
                </div>

                <!-- 載入中動畫 -->
                <div id="loadingState" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-white/80 z-20">
                    <div class="flex gap-2 mb-4">
                        <div class="w-4 h-4 bg-violet-400 rounded-full bounce-dot"></div>
                        <div class="w-4 h-4 bg-violet-400 rounded-full bounce-dot"></div>
                        <div class="w-4 h-4 bg-violet-400 rounded-full bounce-dot"></div>
                    </div>
                    <p class="text-violet-500 font-bold animate-pulse">正在編織故事...</p>
                </div>

                <!-- 故事內容 -->
                <div id="storyContent" class="hidden relative z-0">
                    <h1 id="storyTitle" class="text-3xl font-bold text-violet-800 mb-6 text-center border-b-2 border-violet-100 pb-4"></h1>
                    <div id="storyBody" class="text-slate-700 text-lg text-justify whitespace-pre-line leading-loose"></div>
                    
                    <div class="mt-8 pt-8 border-t border-dashed border-violet-200 flex justify-center">
                        <span class="text-violet-300 text-sm">~ The End ~</span>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <script>
        lucide.createIcons();
        
        let currentStyle = '溫馨童話';

        // 檢查 API Key
        window.onload = () => {
            const apiKey = localStorage.getItem('my_gemini_key');
            if (!apiKey) {
                alert('⚠️ 偵測到尚未設定 API Key！\n請先回到「魔法屋首頁」設定您的金鑰。');
                window.location.href = 'index.html';
            }
        };

        // 風格按鈕切換邏輯
        function setStyle(btn, style) {
            currentStyle = style;
            // 移除所有按鈕的 active 樣式
            document.querySelectorAll('.style-btn').forEach(b => {
                b.classList.remove('bg-violet-500', 'text-white', 'ring-2', 'ring-violet-300');
                b.classList.add('text-violet-500', 'hover:bg-violet-50');
            });
            // 加上當前按鈕的 active 樣式
            btn.classList.remove('text-violet-500', 'hover:bg-violet-50');
            btn.classList.add('bg-violet-500', 'text-white', 'ring-2', 'ring-violet-300');
        }
        // 初始化第一個按鈕狀態
        document.querySelector('.style-btn').click();


        // 核心生成邏輯
        async function generateStory() {
            const apiKey = localStorage.getItem('my_gemini_key');
            const keywords = document.getElementById('keywords').value.trim();
            const lengthVal = document.getElementById('lengthSlider').value;
            
            if (!keywords) {
                alert('請輸入一些關鍵字，讓 AI 知道要寫什麼喔！');
                return;
            }

            // 1. 準備長度描述
            let lengthDesc = "大約300字左右的短篇故事";
            if (lengthVal == 2) lengthDesc = "大約600字左右，情節完整的故事";
            if (lengthVal == 3) lengthDesc = "大約1000字，細節豐富的長篇故事";

            // 2. UI 狀態切換
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('storyContent').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtn').innerHTML = '<span class="animate-spin">⏳</span> 施法中...';

            // 3. 建構 Prompt (這是給 AI 的指令)
            // 技巧：明確指定角色、格式(JSON)、以及語言風格
            const prompt = `
                你是一位充滿想像力的暢銷童書作家。請根據以下要求寫一篇故事：
                - 關鍵字/元素：${keywords}
                - 風格：${currentStyle}
                - 篇幅：${lengthDesc}
                - 語言：繁體中文 (Traditional Chinese)
                
                請嚴格依照以下 JSON 格式回傳，不要有多餘的字：
                {
                    "title": "這裡填寫你想的故事標題",
                    "content": "這裡填寫故事內容，請適當分段。"
                }
            `;

            try {
                // 4. 呼叫 Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);

                // 5. 解析回傳資料
                const rawText = data.candidates[0].content.parts[0].text;
                // 有時候 AI 會在 JSON 前後包 ```json ... ```，需要清乾淨
                const jsonStr = rawText.replace(/```json|```/g, '').trim();
                const storyData = JSON.parse(jsonStr);

                // 6. 顯示結果 (加上打字機特效)
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('storyContent').classList.remove('hidden');
                
                document.getElementById('storyTitle').innerText = storyData.title;
                document.getElementById('storyBody').innerHTML = ''; // 清空舊內容
                
                await typeWriterEffect(document.getElementById('storyBody'), storyData.content);

            } catch (error) {
                console.error(error);
                alert('魔法失靈了！錯誤訊息：' + error.message);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
            } finally {
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('generateBtn').innerHTML = '<i data-lucide="wand-2" class="w-5 h-5"></i> <span>再次施展魔法</span>';
                lucide.createIcons();
            }
        }

        // 打字機特效函數
        function typeWriterEffect(element, text) {
            return new Promise(resolve => {
                let i = 0;
                const speed = 30; // 打字速度 (毫秒)
                
                function type() {
                    if (i < text.length) {
                        // 處理換行符號
                        if (text.charAt(i) === '\n') {
                            element.innerHTML += '<br>';
                        } else {
                            element.innerHTML += text.charAt(i);
                        }
                        i++;
                        setTimeout(type, speed);
                    } else {
                        resolve();
                    }
                }
                type();
            });
        }

    </script>
</body>
</html>